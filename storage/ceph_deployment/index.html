<!doctype html>
<html data-bs-theme="">
    <head>
                <title>Deploying a Ceph Cluster with cephadm - AWNET</title>

            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">

            
            
            

            
                <link  rel="icon" type="image/x-icon" href="../../assets/img/favicon.ico">
            
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

            <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
            <link rel="stylesheet" href="../../assets/css/root.min.css">
            <link rel="stylesheet" href="../../assets/css/main.min.css">
            <link rel="stylesheet" href="../../assets/css/media.min.css">
            <link rel="stylesheet" href="../../assets/css/mkdocstrings.min.css">

            
                
            
    </head>

    <body>
        <div class="container py-3">
            <header>
                    <!-- block header -->
<nav class="navbar navbar-expand-xl border-bottom">
    <div class="container-fluid">
        

        
            <span class=" fs-4 title-color site-name" id="component-site-name" style="text-transform: uppercase;">AWNET</span>
        

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
            aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
            <ul class="navbar-nav">

                <!-- block menu -->
                <li class="nav-item">
                    <!-- block menu -->
    
        <li class="nav-item" id="component-menu">
            <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="
                            nav-link text-gray text-decoration-none" href="../..">[Home]</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Electrical]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../electrical/UK_Qualification_Requirements/" class="dropdown-item text-decoration-none ">UK Qualification Requirements</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../electrical/electrical_certificates/" class="dropdown-item text-decoration-none ">Electrical certificates</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Hpc]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../hpc/slurm_basics/" class="dropdown-item text-decoration-none ">Slurm basics</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Networking]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/hybrid_cloud_networking_to_azure/" class="dropdown-item text-decoration-none ">Hybrid cloud networking to azure</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/mclag/" class="dropdown-item text-decoration-none ">Mclag</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/networking_terminology/" class="dropdown-item text-decoration-none ">Networking terminology</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/sonic_cli_commands/" class="dropdown-item text-decoration-none ">Sonic cli commands</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/spanning_tree/" class="dropdown-item text-decoration-none ">Spanning tree</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/vxlan/" class="dropdown-item text-decoration-none ">Vxlan</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Operations]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../operations/build_you_own_chatgpt/" class="dropdown-item text-decoration-none ">Build you own chatgpt</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../operations/openstack_baremetal_enroll/" class="dropdown-item text-decoration-none ">Openstack baremetal enroll</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../operations/openstack_images/" class="dropdown-item text-decoration-none ">Openstack images</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../operations/openstack_kolla_deployment/" class="dropdown-item text-decoration-none ">Openstack kolla deployment</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../operations/openstack_networking/" class="dropdown-item text-decoration-none ">Openstack networking</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../operations/openstack_overview/" class="dropdown-item text-decoration-none ">Openstack overview</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class=" active 
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Storage]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="./" class="dropdown-item text-decoration-none  active ">Deploying a Ceph Cluster with cephadm</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../ceph_storage_systems/" class="dropdown-item text-decoration-none ">Ceph storage systems</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../ceph_terminology/" class="dropdown-item text-decoration-none ">Ceph terminology</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../linux_storage_commands/" class="dropdown-item text-decoration-none ">Linux storage commands</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../lustre_overview/" class="dropdown-item text-decoration-none ">Lustre overview</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../zfs_terminology/" class="dropdown-item text-decoration-none ">Zfs terminology</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
            </ul>
        </li>
<!-- endblock -->
                </li>
                <!-- endblock -->

                <!-- block search -->
                <li class="nav-item">
                    <a class="collapsed" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                        <div class="md-search-icon">
                            <i class="fa fa-search" aria-hidden="true"></i>
                        </div>
                    </a>
                </li>
                <!--  endblock -->

                <!-- block source -->
                <li class="nav-item">
                    
                        
                    
                </li>
                <!--  endblock -->
            </ul>
        </div>
    </div>
</nav>
<!--  endblock -->
            </header>

            <main>

                
                        <!-- block content -->
<section class="container post" id="component-content">
    <article>
        <header>
            
                <h1 class=" title" id="component-title">Deploying a Ceph Cluster with cephadm</h1>
            
        </header>
        <p><h1 id="deploying-a-ceph-cluster-with-cephadm">Deploying a Ceph Cluster with cephadm</h1>
<h2 id="host-setup">Host Setup</h2>
<p>For a Ceph cluster you require a minimum of 3 hosts. This setup was done using Rocky Linux 9 so commands used here will only work with a CentOS distro.</p>
<p>The primary host will need to have SSH access to all other hosts in the Ceph cluster.</p>
<p>All hosts need to have <code>podman</code> and <code>lvm2</code> installed:</p>
<pre><code>dnf install -y podman lvm2
</code></pre>
<p>From the primary host, install cephadm</p>
<pre><code>dnf search release-ceph
dnf install --assumeyes centos-release-ceph-squid
dnf install --assumeyes cephadm
</code></pre>
<h2 id="bootstrap">Bootstrap</h2>
<p>From the primary monitor host, run the following commands to bootstrap the Ceph cluster. MONITOR_IP needs to be set to the IP address of the host.</p>
<pre><code>cephadm bootstrap --mon-ip=MONITOR_IP
</code></pre>
<h2 id="add-hosts-to-cluster">Add Hosts to Cluster</h2>
<p>Firstly, the public key generated for the Ceph cluster needs to be shared to the other cluster hosts:</p>
<pre><code>ssh-copy-id -f -i /etc/ceph/ceph.pub root@$HOST_IP
</code></pre>
<p>From the primary host, run the following commands to add a new host to the Ceph cluster:</p>
<pre><code>cephadm shell
ceph orch host add ceph-X $HOST_IP
</code></pre>
<p>You can verify that the host has been added with:</p>
<pre><code>ceph status
</code></pre>
<p>Additionally, you can log onto the new host, and confirm that podman is running Ceph containers:</p>
<pre><code>podman ps
</code></pre>
<p>This registers the hosts monitors and backup managers, but not OSD hosts. Without OSDs, Ceph will report no available storage.</p>
<h2 id="object-storage-daemon">Object Storage Daemon</h2>
<p>The Ceph OSD is deployed on Ceph cluster hosts to manage block storage devices.</p>
<p>The below command will show what devices are available from what hosts:</p>
<pre><code>ceph orch device ls --refresh

##########################################################################################################################################################
HOST    PATH      TYPE  DEVICE ID                                                 SIZE  AVAILABLE  REFRESHED  REJECT REASONS
ceph-1  /dev/sdb  hdd   QEMU_QEMU_HARDDISK_6e7a5cd8-16de-43ef-a8c4-b737064e8f59  6144M  Yes        3m ago
ceph-1  /dev/sr0  ssd   QEMU_DVD-ROM_QM00003                                      474k  No         3m ago     Has a FileSystem, Insufficient space (&lt;5GB)
ceph-2  /dev/sdb  hdd   QEMU_QEMU_HARDDISK_78d6c800-aad6-45a0-91ca-8ee23ac569ce  6144M  Yes        3m ago
ceph-2  /dev/sr0  hdd   QEMU_DVD-ROM_QM00003                                      474k  No         3m ago     Has a FileSystem, Insufficient space (&lt;5GB)
ceph-3  /dev/sdb  hdd   QEMU_QEMU_HARDDISK_06803200-1fc8-4a10-8f33-e36b58145dee  6144M  Yes        111s ago
ceph-3  /dev/sr0  hdd   QEMU_DVD-ROM_QM00003                                      474k  No         111s ago   Has a FileSystem, Insufficient space (&lt;5GB)
</code></pre>
<p>Providing a storage device is &gt;5GB, has no partitions or LVM state, then it can be considered available.</p>
<p>We can then deploy OSDs onto these hosts to manage these devices with the command below:</p>
<pre><code>ceph orch apply osd --all-available-devices

# Alternatively target specific device
ceph orch daemon add osd ceph-1:/dev/sdb
</code></pre>
<p>You can be even more granular with the OSD specifications using the Ceph orchestrator. Below is an example of a yaml file which specifies to use spinning disks for the OSD and the Bluestore database to be configured on SSD.</p>
<pre><code class="language-yaml">service_type: osd
service_id: osd_all
placement:
  host_pattern: ceph-0
data_devices:
  rotational: 1
db_devices:
  rotational: 0
</code></pre>
<p>This will deploy a new orch service which</p>
<p>A new OSD daemon conatiner will be visible under the podman running containers. Once they have registered, the storage should be visible on the cluster:</p>
<pre><code>[ceph: root@ceph-1 /]# ceph status
  cluster:
    id:     a1d4a086-502a-11f0-b3b0-fa163e27aeff
    health: HEALTH_OK

  services:
    mon: 3 daemons, quorum ceph-1,ceph-3,ceph-2 (age 87s)
    mgr: ceph-1.cksalp(active, since 10m), standbys: ceph-3.cjvulx
    osd: 3 osds: 3 up (since 16s), 3 in (since 52s)

  data:
    pools:   1 pools, 1 pgs
    objects: 2 objects, 577 KiB
    usage:   81 MiB used, 18 GiB / 18 GiB avail
    pgs:     1 active+clean
</code></pre></p>
    </article>
</section>
<!-- endblock -->
                
                
            </main>

            
                    <!-- block preview -->
    <div class="preview row row-cols-md-3 text-center pt-md-3" id="component-preview">
        <div class="col themed-grid-col">
            <a rel="prev" href="../../operations/openstack_overview/" class="nav-link">
                <i class="fa fa-arrow-left"></i> Previous
            </a>
        </div>
        <div class="col themed-grid-col"></div>
        <div class="col themed-grid-col">
            <a rel="next" href="../ceph_storage_systems/" class="nav-link">
                Next <i class="fa fa-arrow-right"></i>
            </a>
        </div>
    </div>
<!-- endblock -->
            

            
                    <!-- block footer -->
<footer class="pt-4 my-md-5 pt-md-5 border-top" id="component-footer">
    <div class="row">
        <div class="col-12 col-md">
                <!-- block copyright -->

    <small class="d-block mb-3">
        Made with
        <a href="https://github.com/FernandoCelmer/mkdocs-simple-blog" target="_blank" rel="noopener">
            Simple Blog for MkDocs
        </a>
    </small>

<!-- endblock -->
        </div>
    </div>
</footer>
<!-- endblock -->
            
        </div>

            <script>var base_url = '../..';</script>
            <script src="../../assets/js/jquery-3.3.1.slim.min.js""></script>
            <script src="../../assets/js/bootstrap.bundle.min.js""></script>
            <script src="../../assets/js/main.min.js""></script>

    </body>

</html>