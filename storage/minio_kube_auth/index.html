<!doctype html>
<html data-bs-theme="">
    <head>
                <title>Minio kube auth - AWNET</title>

            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">

            
            <link rel="canonical" href="https://awalford16.github.io/storage/minio_kube_auth/">
            

            
                <link  rel="icon" type="image/x-icon" href="../../assets/img/favicon.ico">
            
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

            <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
            <link rel="stylesheet" href="../../assets/css/root.min.css">
            <link rel="stylesheet" href="../../assets/css/main.min.css">
            <link rel="stylesheet" href="../../assets/css/media.min.css">
            <link rel="stylesheet" href="../../assets/css/mkdocstrings.min.css">

            
                
            
    </head>

    <body>
        <div class="container py-3">
            <header>
                    <!-- block header -->
<nav class="navbar navbar-expand-xl border-bottom">
    <div class="container-fluid">
        

        
            <span class=" fs-4 title-color site-name" id="component-site-name" style="text-transform: uppercase;">AWNET</span>
        

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
            aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
            <ul class="navbar-nav">

                <!-- block menu -->
                <li class="nav-item">
                    <!-- block menu -->
    
        <li class="nav-item" id="component-menu">
            <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="
                            nav-link text-gray text-decoration-none" href="../..">[Home]</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[HPC]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../HPC/AWS_parallel_cluster/" class="dropdown-item text-decoration-none ">AWS parallel cluster</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../HPC/slurm_basics/" class="dropdown-item text-decoration-none ">Slurm basics</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../HPC/spack/" class="dropdown-item text-decoration-none ">Spack</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Electrical]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../electrical/UK_Qualification_Requirements/" class="dropdown-item text-decoration-none ">UK Qualification Requirements</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../electrical/electrical_certificates/" class="dropdown-item text-decoration-none ">Electrical certificates</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Networking]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/FEC/" class="dropdown-item text-decoration-none ">FEC</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/MCLAG/" class="dropdown-item text-decoration-none ">MCLAG</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/VXLAN/" class="dropdown-item text-decoration-none ">VXLAN</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/hybrid_cloud_networking_to_azure/" class="dropdown-item text-decoration-none ">Hybrid cloud networking to azure</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/networking_terminology/" class="dropdown-item text-decoration-none ">Networking terminology</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/radius/" class="dropdown-item text-decoration-none ">Radius</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/sonic_cli_commands/" class="dropdown-item text-decoration-none ">Sonic cli commands</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../networking/spanning_tree/" class="dropdown-item text-decoration-none ">Spanning tree</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Openstack]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../openstack/azimuth/" class="dropdown-item text-decoration-none ">Azimuth</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../openstack/openstack_baremetal_enroll/" class="dropdown-item text-decoration-none ">Openstack baremetal enroll</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../openstack/openstack_images/" class="dropdown-item text-decoration-none ">Openstack images</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../openstack/openstack_kolla_deployment/" class="dropdown-item text-decoration-none ">Openstack kolla deployment</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../openstack/openstack_networking/" class="dropdown-item text-decoration-none ">Openstack networking</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../openstack/openstack_overview/" class="dropdown-item text-decoration-none ">Openstack overview</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Operations]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../../operations/Build_you_own_ChatGPT/" class="dropdown-item text-decoration-none ">Build you own ChatGPT</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class=" active 
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Storage]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../ZFS_terminology/" class="dropdown-item text-decoration-none ">ZFS terminology</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../ceph_deployment/" class="dropdown-item text-decoration-none ">Deploying a Ceph Cluster with cephadm</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../ceph_storage_systems/" class="dropdown-item text-decoration-none ">Ceph storage systems</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../ceph_terminology/" class="dropdown-item text-decoration-none ">Ceph terminology</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../linux_storage_commands/" class="dropdown-item text-decoration-none ">Linux storage commands</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../lustre_overview/" class="dropdown-item text-decoration-none ">Lustre overview</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="./" class="dropdown-item text-decoration-none  active ">Minio kube auth</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
            </ul>
        </li>
<!-- endblock -->
                </li>
                <!-- endblock -->

                <!-- block search -->
                <li class="nav-item">
                    <a class="collapsed" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                        <div class="md-search-icon">
                            <i class="fa fa-search" aria-hidden="true"></i>
                        </div>
                    </a>
                </li>
                <!--  endblock -->

                <!-- block source -->
                <li class="nav-item">
                    
                        
                    
                </li>
                <!--  endblock -->
            </ul>
        </div>
    </div>
</nav>
<!--  endblock -->
            </header>

            <main>

                
                        <!-- block content -->
<section class="container post" id="component-content">
    <article>
        <header>
            
                <h1 class=" title" id="component-title">Minio kube auth</h1>
            
        </header>
        <p><h2 id="sts-authentication">STS Authentication</h2>
<p>Minio Security Token Service provides a way of authenticating with Minio tenants without needing to create authentication credentials on the tenant.</p>
<p>In this setup, we will be using Kubernetes service accounts with the <code>AssumeRoleWithWebIdentity</code> action for acquiring Minio access credentials.</p>
<h3 id="minio-setup">Minio Setup</h3>
<p>We will be using the Minio helm chart to deploy a tenant for testing the STS authantication. Add the Minio Helm repository:</p>
<pre><code>helm repo add minio https://operator.min.io
helm repo update
</code></pre>
<p>Install the Minio Operator:</p>
<pre><code>helm install operator minio/operator -n minio-operator --create-namespace
</code></pre>
<p>The operator allows us to provision multiple Minio tenants using Minio CRDs. We can now deploy a Minio tenant once the operator pods are up and running:</p>
<pre><code>helm install tenant minio/tenant -n minio-tenant --create-namespace
</code></pre>
<p>This will deploy a <code>tenant</code> custom resource which can be checked with <code>kubectl get tenants</code>.</p>
<p>The tenants will need to be configured with TLS enabled. By default the Helm chart configures the tenants with "auto-cert", which will use the Kubernetes CA cert on the cluster for generating TLS certificates for communication between the client, tenant and the Minio operator. This can be disabled and certs can be managed manually by configurating the chart valies with <code>certificate.requestAutoCert=false</code>. There are Minio STS deployment examples here on how to configure certificates with CertManager: https://github.com/minio/operator/tree/master/examples/kustomization/sts-example.</p>
<h3 id="service-account-setup">Service Account Setup</h3>
<p>The token that will be passed to the STS endpoint for authentication will be the JWT tied to a Kubernetes service account. The <code>yaml</code> below will create a service account in the cluster which will be assigned to a client service.</p>
<pre><code class="language-yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: minio-client-sa
</code></pre>
<p>When assigning the service account to the client deployment, the <code>sts.min.io</code> audience needs to be added to the token, which can be achieved using projected volume mounts:</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: minio-client
spec:
  template:
    spec:
      containers:
        - name: minio-client
          image: $IMAGE
          name: fridge-api-server
          ports:
            - containerPort: 8000
              protocol: TCP
          volumeMounts:
            - mountPath: /minio
              name: minio-client-sa
              readOnly: true
      serviceAccountName: minio-client-sa
      volumes:
        - name: minio-client-sa
          projected:
            sources:
              - serviceAccountToken:
                  audience: sts.min.io
                  path: token
</code></pre>
<p>The service account token with the projected audience will be mounted at <code>/minio/token</code>.</p>
<h3 id="policy-binding">Policy Binding</h3>
<p>The service account needs to be bound to a Minio policy. This can be achieved using the Minio <code>PolicyBinding</code> CRD:</p>
<pre><code class="language-yaml">apiVersion: sts.min.io/v1beta1
kind: PolicyBinding
metadata:
  name: minio-client-readonly
spec:
  application:
    namespace: client # Namespace of the client using the service account
    serviceaccount: minio-client-sa # Service account name
  policies:
    - readonly
</code></pre>
<h3 id="python-client">Python Client</h3>
<p>Minio STS requires TLS encryption to work. Since the certificates used by the Minio tenant and operator are issued by the cluster CA, the CA cert needs to be trusted within the client. The certificates are also only valid for internal cluster URLs (e.g. <code>svc.cluster.local</code>), meaning the client needs to be running from somewhere where that can be resolved.</p>
<p>This certificate is already accessible within the pod when a Kubernetes service account is assigned to the pod. The cert can be found in the pod under <code>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</code></p>
<p>The Python script below assumes that it is running within the cluster, with the internal Kube DNS to resolve <code>svc.cluster.local</code>. It passes the cluster certificate into the SSL context for the HTTP call, which calls the <code>/sts/$TENANT</code> Minio operator STS endpoint passing the <code>Action=AssumeRoleWithWebIdentity</code> and <code>WebIdentityToken=$JWT</code>.</p>
<pre><code class="language-python">import ssl
import urllib3
from pathlib import Path

SA_TOKEN_FILE = &quot;/minio/token&quot;
KUBE_CA_CRT = &quot;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&quot;
STS_ENDPOINT = &quot;https://sts.minio-operator.svc.cluster.local:4223&quot;
TENANT = &quot;minio-tenant&quot;

# Read service account token
sa_token = Path(SA_TOKEN_FILE).read_text().strip()

ssl_context = ssl.create_default_context(cafile=KUBE_CA_CRT)

# Create urllib3 client which accepts kube CA cert
http = urllib3.PoolManager(ssl_context=ssl_context)

# Send the token to the MinIO STS endpoint
response = http.request(
    &quot;POST&quot;,
    f&quot;{STS_ENDPOINT}/sts/{TENANT}?Action=AssumeRoleWithWebIdentity&amp;Version=2011-06-15&amp;WebIdentityToken={sa_token}&quot;,
)

print(response.data)
</code></pre>
<p>Providing all went to plan, Minio should return a block of XML containing the access and secret key, looking similar to the block below.</p>
<pre><code class="language-xml">&lt;AssumeRoleWithWebIdentityResponse xmlns=&quot;https://sts.amazonaws.com/doc/2011-06-15/&quot;&gt;
    &lt;AssumeRoleWithWebIdentityResult&gt;
        &lt;AssumedRoleUser&gt;
            &lt;Arn&gt;&lt;/Arn&gt;
            &lt;AssumeRoleId&gt;&lt;/AssumeRoleId&gt;
        &lt;/AssumedRoleUser&gt;
        &lt;Credentials&gt;
            &lt;AccessKeyId&gt;ACCESS_KEY&lt;/AccessKeyId&gt;
            &lt;SecretAccessKey&gt;SECRET_KET&lt;/SecretAccessKey&gt;
            &lt;Expiration&gt;2020-12-25T00:00:50Z&lt;/Expiration&gt;
            &lt;SessionToken&gt;JWT&lt;/SessionToken&gt;
        &lt;/Credentials&gt;
    &lt;/AssumeRoleWithWebIdentityResult&gt;
    &lt;ResponseMetadata&gt;&lt;/ResponseMetadata&gt;
&lt;/AssumeRoleWithWebIdentityResponse&gt;
</code></pre>
<p>This XML can then be parsed to grab the keys and configure the minio Python client.</p>
<pre><code class="language-python">from minio import Minio

minio_client = Minio(
  &quot;minio.minio-tenant.svc.cluster.local:9000&quot;,
  access_key=$ACCESS_KEY,
  secret_key=$SECRET_KEY,
  secure=True,
)
</code></pre></p>
    </article>
</section>
<!-- endblock -->
                
                
            </main>

            
                    <!-- block preview -->
    <div class="preview row row-cols-md-3 text-center pt-md-3" id="component-preview">
        <div class="col themed-grid-col">
            <a rel="prev" href="../lustre_overview/" class="nav-link">
                <i class="fa fa-arrow-left"></i> Previous
            </a>
        </div>
        <div class="col themed-grid-col"></div>
        <div class="col themed-grid-col">
            <a rel="next" class="nav-link disabled">
                Next <i class="fa fa-arrow-right"></i>
            </a>
        </div>
    </div>
<!-- endblock -->
            

            
                    <!-- block footer -->
<footer class="pt-4 my-md-5 pt-md-5 border-top" id="component-footer">
    <div class="row">
        <div class="col-12 col-md">
                <!-- block copyright -->

    <small class="d-block mb-3">
        Made with
        <a href="https://github.com/FernandoCelmer/mkdocs-simple-blog" target="_blank" rel="noopener">
            Simple Blog for MkDocs
        </a>
    </small>

<!-- endblock -->
        </div>
    </div>
</footer>
<!-- endblock -->
            
        </div>

            <script>var base_url = '../..';</script>
            <script src="../../assets/js/jquery-3.3.1.slim.min.js""></script>
            <script src="../../assets/js/bootstrap.bundle.min.js""></script>
            <script src="../../assets/js/main.min.js""></script>

    </body>

</html>